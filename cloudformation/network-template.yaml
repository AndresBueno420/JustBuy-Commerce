AWSTemplateFormatVersion: '2010-09-09'
Description: >
  (1/3) Red completa: VPC, subredes públicas/privadas, IGW, NAT,
  tablas de ruteo, security groups y Bastion Host.

Parameters:
  KeyName:
    Description: 'Tu Key Pair de EC2 (control.pem)'
    Type: 'AWS::EC2::KeyPair::KeyName'
    Default: 'control'

  AmiId:
    Description: 'AMI de Amazon Linux 2 para us-east-1'
    Type: 'AWS::EC2::Image::Id'
    Default: 'ami-03c870feb7c37e4ff'

  BastionAllowedCidr:
    Description: 'CIDR desde el cual se permite SSH al Bastion Host'
    Type: String
    Default: '0.0.0.0/0'

Resources:
  # --- VPC ---
  VPC:
    Type: 'AWS::EC2::VPC'
    Properties:
      CidrBlock: '10.0.0.0/16'
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: 'Project-VPC-Final'

  InternetGateway:
    Type: 'AWS::EC2::InternetGateway'
    Properties:
      Tags:
        - Key: Name
          Value: 'Project-IGW-Final'

  AttachGateway:
    Type: 'AWS::EC2::VPCGatewayAttachment'
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # --- Subredes públicas ---
  PublicSubnetA:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      CidrBlock: '10.0.1.0/24'
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: 'Project-Public-Subnet-A'

  PublicSubnetB:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      CidrBlock: '10.0.2.0/24'
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: 'Project-Public-Subnet-B'

  # --- Subredes privadas ---
  PrivateSubnetA:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      CidrBlock: '10.0.3.0/24'
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: 'Project-Private-Subnet-A'

  PrivateSubnetB:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      CidrBlock: '10.0.4.0/24'
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: 'Project-Private-Subnet-B'

  # --- Ruteo público ---
  PublicRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: 'Project-Public-RouteTable'

  PublicRoute:
    Type: 'AWS::EC2::Route'
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref InternetGateway

  PublicSubnetAAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PublicSubnetA
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetBAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PublicSubnetB
      RouteTableId: !Ref PublicRouteTable

  # --- NAT + ruteo privado ---
  NatEIP:
    Type: 'AWS::EC2::EIP'
    Properties:
      Domain: vpc

  NatGateway:
    Type: 'AWS::EC2::NatGateway'
    Properties:
      AllocationId: !GetAtt NatEIP.AllocationId
      SubnetId: !Ref PublicSubnetA
      Tags:
        - Key: Name
          Value: 'Project-NAT-Gateway'

  PrivateRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: 'Project-Private-RouteTable'

  PrivateRoute:
    Type: 'AWS::EC2::Route'
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      NatGatewayId: !Ref NatGateway

  PrivateSubnetAAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PrivateSubnetA
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnetBAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PrivateSubnetB
      RouteTableId: !Ref PrivateRouteTable

  # --- Security Groups ---
  BastionSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Permite SSH hacia el Bastion desde BastionAllowedCidr'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - CidrIp: !Ref BastionAllowedCidr
          IpProtocol: tcp
          FromPort: 22
          ToPort: 22
      Tags:
        - Key: Name
          Value: 'Project-SG-Bastion'

  AppSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Allow App (3000) desde ALB y SSH solo desde Bastion'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - CidrIp: '0.0.0.0/0'
          IpProtocol: tcp
          FromPort: 80
          ToPort: 80
        - CidrIp: '10.0.0.0/16'
          IpProtocol: tcp
          FromPort: 3000
          ToPort: 3000
        - SourceSecurityGroupId: !Ref BastionSecurityGroup
          IpProtocol: tcp
          FromPort: 22
          ToPort: 22
      Tags:
        - Key: Name
          Value: 'Project-SG-App-Final'

  DBSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Allows Postgres (5432) only from the App SG'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - SourceSecurityGroupId: !Ref AppSecurityGroup
          IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
      Tags:
        - Key: Name
          Value: 'Project-SG-DB-Final'

  # --- Bastion Host ---
  BastionHost:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: 't2.micro'
      ImageId: !Ref AmiId
      KeyName: !Ref KeyName
      SubnetId: !Ref PublicSubnetA
      SecurityGroupIds:
        - !Ref BastionSecurityGroup
      Tags:
        - Key: Name
          Value: 'Project-Bastion-Host'

Outputs:
  VpcId:
    Description: 'ID de la VPC'
    Value: !Ref VPC

  PublicSubnetAId:
    Description: 'Subred pública A'
    Value: !Ref PublicSubnetA

  PublicSubnetBId:
    Description: 'Subred pública B'
    Value: !Ref PublicSubnetB

  PrivateSubnetAId:
    Description: 'Subred privada A'
    Value: !Ref PrivateSubnetA

  PrivateSubnetBId:
    Description: 'Subred privada B'
    Value: !Ref PrivateSubnetB

  AppSecurityGroupId:
    Description: 'Security Group de la App'
    Value: !Ref AppSecurityGroup

  DBSecurityGroupId:
    Description: 'Security Group de la DB'
    Value: !Ref DBSecurityGroup

  BastionPublicIP:
    Description: 'IP pública del Bastion Host para SSH'
    Value: !GetAtt BastionHost.PublicIp