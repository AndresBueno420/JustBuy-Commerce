AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Plantilla ÚNICA y COMPLETA. Despliega la Red (VPC, Subredes Públicas), 
  la Base de Datos (RDS) y la Aplicación (ALB, ASG, EC2) en un solo paso.
  Enfoque simple para depuración.

Parameters:
  # --- 1. PARÁMETROS GENERALES ---
  KeyName:
    Description: 'Tu Key Pair de EC2 (control.pem)'
    Type: 'AWS::EC2::KeyPair::KeyName'
    Default: 'control'

  InstanceRoleName:
    Description: 'El Perfil de Instancia de IAM (encontrado en tu sandbox)'
    Type: String
    Default: 'myS3Role'

  GitRepoURL:
    Description: 'La URL HTTPS de tu repositorio Git'
    Type: String
    Default: 'https://github.com/tu-usuario/JustBuy-Commerce.git'

  
  # --- 2. PARÁMETROS DE SECRETOS ---
  DBName:
    Description: 'Nombre de la base de datos'
    Type: String
    Default: 'ecommerce_db'
  
  DBUser: 
    Description: 'Usuario maestro de la base de datos'
    Type: String
    Default: 'postgres'

  DBPassword: 
    Description: 'Contraseña maestra de la base de datos'
    Type: String
    NoEcho: true
  
  SessionSecret:
    Description: 'Secreto para express-session'
    Type: String
    NoEcho: true
  
  MPAccessToken:
    Description: 'Tu Access Token de Mercado Pago'
    Type: String
    NoEcho: true
    
  AmiId:
    Description: 'AMI de Amazon Linux 2 para us-east-1'
    Type: 'AWS::EC2::Image::Id'
    Default: 'ami-03c870feb7c37e4ff'

Resources:
  # --- 1. RED (VPC) ---
  VPC:
    Type: 'AWS::EC2::VPC'
    Properties:
      CidrBlock: '10.0.0.0/16'
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: 'Project-VPC-Final'

  InternetGateway:
    Type: 'AWS::EC2::InternetGateway'
    Properties:
      Tags:
        - Key: Name
          Value: 'Project-IGW-Final'

  AttachGateway:
    Type: 'AWS::EC2::VPCGatewayAttachment'
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # --- 2. SUBREDES (SOLO PÚBLICAS) ---
  PublicSubnetA:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      CidrBlock: '10.0.1.0/24'
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: 'Project-Public-Subnet-A'

  PublicSubnetB:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      CidrBlock: '10.0.2.0/24'
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: 'Project-Public-Subnet-B'

  # --- 3. RUTEO (SOLO PÚBLICO) ---
  PublicRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: 'Project-Public-RouteTable'

  PublicRoute:
    Type: 'AWS::EC2::Route'
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref InternetGateway

  PublicSubnetAAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PublicSubnetA
      RouteTableId: !Ref PublicRouteTable
      
  PublicSubnetBAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PublicSubnetB
      RouteTableId: !Ref PublicRouteTable

  # --- 4. GRUPOS DE SEGURIDAD (FIREWALL) ---
  AppSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Allow App (3000), SSH (22), and ALB (80)'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - CidrIp: '0.0.0.0/0'
          IpProtocol: tcp
          FromPort: 22
          ToPort: 22
        - CidrIp: '0.0.0.0/0'
          IpProtocol: tcp
          FromPort: 80
          ToPort: 80
        - CidrIp: '10.0.0.0/16' 
          IpProtocol: tcp
          FromPort: 3000
          ToPort: 3000
      Tags:
        - Key: Name
          Value: 'Project-SG-App-Final'

  DBSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Allows Postgres (5432) only from the App SG'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - SourceSecurityGroupId: !Ref AppSecurityGroup
          IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
      Tags:
        - Key: Name
          Value: 'Project-SG-DB-Final'

  # --- 5. BASE DE DATOS (RDS) ---
  DBSubnetGroup:
    Type: 'AWS::RDS::DBSubnetGroup'
    Properties:
      DBSubnetGroupDescription: 'Subnet group for RDS (using public subnets)'
      SubnetIds:
        - !Ref PublicSubnetA
        - !Ref PublicSubnetB
      Tags:
        - Key: Name
          Value: 'Project-RDS-SubnetGroup-Final'

  RDSInstance:
    Type: 'AWS::RDS::DBInstance'
    Properties:
      Engine: 'postgres'
      EngineVersion: '15'
      DBInstanceClass: 'db.t3.micro'
      MultiAZ: false
      AllocatedStorage: '20'
      StorageType: 'gp2'
      MonitoringInterval: 0
      DBName: !Ref DBName
      MasterUsername: !Ref DBUser     
      MasterUserPassword: !Ref DBPassword 
      DBSubnetGroupName: !Ref DBSubnetGroup
      VPCSecurityGroups:
        - !Ref DBSecurityGroup
      PubliclyAccessible: false
      BackupRetentionPeriod: 0 
      Tags:
        - Key: Name
          Value: 'Project-RDS-Instance-Final'

  # --- 6. APLICACIÓN (ALB, ASG, EC2) ---
  AppLoadBalancer:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      Name: 'Project-ALB-Final'
      Subnets:
        - !Ref PublicSubnetA
        - !Ref PublicSubnetB
      SecurityGroups:
        - !Ref AppSecurityGroup 
      Scheme: 'internet-facing'
      Tags:
        - Key: Name
          Value: 'Project-ALB-Final'

  ALBTargetGroup:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      Name: 'Project-TG-App-Final'
      VpcId: !Ref VPC
      Protocol: 'HTTP'
      Port: 3000
      HealthCheckPath: '/login.html'
      HealthCheckIntervalSeconds: 30
      TargetType: 'instance'

  ALBListener:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      LoadBalancerArn: !Ref AppLoadBalancer
      Protocol: 'HTTP'
      Port: 80
      DefaultActions:
        - Type: 'forward'
          TargetGroupArn: !Ref ALBTargetGroup

  AppLaunchTemplate:
    Type: 'AWS::EC2::LaunchTemplate'
    Properties:
      LaunchTemplateName: 'Project-Launch-Template-Final'
      LaunchTemplateData:
        InstanceType: 't2.micro'
        ImageId: !Ref AmiId
        KeyName: !Ref KeyName
        SecurityGroupIds:
          - !Ref AppSecurityGroup
        IamInstanceProfile:
          Name: !Ref InstanceRoleName
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            yum update -y
            yum install -y git
            yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm
            systemctl enable amazon-ssm-agent
            systemctl start amazon-ssm-agent
            su - ec2-user -c "
              curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
              . /home/ec2-user/.nvm/nvm.sh
              nvm install 18
              npm install -g pm2
            "
            cd /home/ec2-user
            git clone https://github.com/AndresBueno420/JustBuy-Commerce.git
            APP_PATH="/home/ec2-user/JustBuy-Commerce/app"
            cd $APP_PATH 
            echo "NODE_ENV=production" > .env
            echo "PORT=3000" >> .env
            echo "DB_HOST=${RDSInstance.Endpoint.Address}" >> .env
            echo "DB_PORT=${RDSInstance.Endpoint.Port}" >> .env
            echo "DB_NAME=${DBName}" >> .env
            echo "DB_USER=${DBUser}" >> .env
            echo "DB_PASS=${DBPassword}" >> .env
            echo "SESSION_SECRET=${SessionSecret}" >> .env
            echo "MERCADOPAGO_ACCESS_TOKEN=${MPAccessToken}" >> .env
            chown -R ec2-user:ec2-user /home/ec2-user/JustBuy-Commerce
            su - ec2-user -c "cd $APP_PATH && npm install"
            
            su - ec2-user -c "
              . /home/ec2-user/.nvm/nvm.sh
              cd $APP_PATH
              npm run seed
            "

            su - ec2-user -c "
              . /home/ec2-user/.nvm/nvm.sh
              cd $APP_PATH
              pm2 start $APP_PATH/server.js -n \"ecommerce-app\"
              pm2 startup
              pm2 save
            "

  AppAutoScalingGroup:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      VPCZoneIdentifier:
        - !Ref PublicSubnetA
        - !Ref PublicSubnetB
      LaunchTemplate:
        LaunchTemplateId: !Ref AppLaunchTemplate
        Version: !GetAtt AppLaunchTemplate.LatestVersionNumber
      MinSize: '1' 
      MaxSize: '3'
      DesiredCapacity: '1'
      TargetGroupARNs:
        - !Ref ALBTargetGroup
      Tags:
        - Key: Name
          Value: 'Project-EC2-App-Final'
          PropagateAtLaunch: true

  ScaleUpPolicy:
    Type: 'AWS::AutoScaling::ScalingPolicy'
    Properties:
      AutoScalingGroupName: !Ref AppAutoScalingGroup
      PolicyType: 'TargetTrackingScaling'
      TargetTrackingConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: 'ASGAverageCPUUtilization'
        TargetValue: 20.0

Outputs:
  LoadBalancerURL:
    Description: 'The public URL for your E-Commerce application'
    Value: !GetAtt AppLoadBalancer.DNSName